image: golang:latest

before_script:
  - go get -u github.com/golang/dep/cmd/dep
  - export GOPATH=$(dirname $CI_PROJECT_DIR)/go
  - mkdir -p $GOPATH/src
  - cd $GOPATH/src
  - ln -s $CI_PROJECT_DIR
  - cd $CI_PROJECT_NAME
  - dep ensure -update

stages:
  - test
  - build

format:
  stage: test
  script:
    - go tool vet -composites=false -shadow=true *.go
    - go test
  #  - go test -race $(go list ./... | grep -v /vendor/)

compiled_varroa_dev:
  stage: build
  script:
    - cd cmd/varroa
    - go build -o ../../varroa
    - cd ../varroa-fuse
    - go build -o ../../varroa-fuse
    - cd ../..
#    - go build -race -ldflags "-extldflags '-static'" -o varroa
  artifacts:
    paths:
    - varroa
    - varroa-fuse
    name: "varroa-dev-${CI_COMMIT_REF_NAME}"
    expire_in: 4 weeks
  except:
    - tags

compiled_varroa_released_version:
  stage: build
  script:
    - cd cmd/varroa
    - go build -o ../../varroa
    - cd ../varroa-fuse
    - go build -o ../../varroa-fuse
    - cd ../..
  artifacts:
    paths:
    - varroa
    - varroa-fuse
    name: "varroa-${CI_COMMIT_REF_NAME}"
  only:
    - tags

